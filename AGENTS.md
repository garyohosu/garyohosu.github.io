# AGENTS.md - ブログ運用ナレッジベース

このファイルはAIエージェント（Claude Code / Codex CLI / Gemini CLI）がブログを運用する際の共通ナレッジベースです。

---

## プロジェクト概要

- **種別**: Jekyll静的ブログサイト（Chirpyテーマ）
- **ホスティング**: GitHub Pages
- **URL**: https://garyohosu.github.io/

## ファイル構成

```
├── CLAUDE.md       # Claude Code用（AGENTS.mdを参照）
├── AGENTS.md       # 共通ナレッジベース（このファイル）
├── CHANGELOG.md    # 変更履歴
├── _posts/         # ブログ記事
├── assets/img/     # 画像ファイル
└── _config.yml     # Jekyll設定（変更注意）
```

## よく使うコマンド

```bash
# 類似ファイル名の確認（記事作成前に必須）
ls _posts/ | grep -i "<キーワード>"

# ローカルビルド（推奨）
bundle exec jekyll build

# Git操作
git status
git diff
git add <file>
git commit -m "メッセージ"
git push
git pull --rebase

# push後のAI自動確認
node scripts/ai-post-push-check.mjs
```

---

## 必読：運用ルール

### 1. 問題発生時の対応

**問題が発生し解決した場合は、必ず以下を実施すること**:

1. 本ファイル（AGENTS.md）の「インシデント記録」セクションに追記
2. 原因と解決方法を明記
3. 再発防止策を「再発防止チェックリスト」に追加

### 2. 変更管理

**何か変更を行った場合は、必ずCHANGELOG.mdに追記すること**:

```markdown
## YYYY-MM-DD
### 変更内容
- 変更した内容の概要
### 理由
- なぜ変更したか
```

### 3. チェックリストの運用

**プッシュ後は必ずチェックリストを「未チェック」の状態に戻すこと。また、各ステップの確認を行うごとにチェックを入れること。**

### 4. プッシュ後確認の自動化

**push後確認は人手確認ではなく、AIエージェントがコマンド実行で自動確認すること。**

```bash
node scripts/ai-post-push-check.mjs
```

このコマンドで、最新の `Build and Deploy` 成功確認、サイトトップURL確認、当該コミットで変更した記事URL確認まで実施する。

---

## 再発防止チェックリスト

### 記事作成前
- [ ] `ls _posts/ | grep "<キーワード>"` で類似ファイル名を確認
- [ ] ファイル名のスラッグ部分が一意か確認（週番号・日付などの識別子を付ける）
- [ ] YAMLフロントマターの引用符が正しいか確認（入れ子の`"`は`「」`に変換）

### 記事作成時
- [ ] `image.path`に指定した画像ファイルが`assets/img/`に存在するか確認
- [ ] フロントマターで`image:`を使う場合も、同様に実在する画像ファイル（`/assets/img/...`）を指定する
- [ ] `pic.md` の画像生成時は `model` と `size` の組み合わせを事前確認（`dall-e-3` は `1792x1024`）
- [ ] note記事紹介時は汎用画像でなく個別のOG画像を取得・保存
- [ ] **数字のみのタグやカテゴリーは必ずクォートしているか確認**（例: `"403"`）
- [ ] 外部URLを使う場合はURLが有効か確認
- [ ] 外部URLが全て`https://`で始まっているか確認（`http://`はエラーになる）

### プッシュ前
- [ ] `git status`で意図しない変更がないか確認
- [ ] `git diff`で変更内容を確認（特に`_config.yml`の変更に注意）
- [ ] 可能であれば`bundle exec jekyll build`でローカルビルド確認

### プッシュ後（★最重要）
- [ ] AIが `node scripts/ai-post-push-check.mjs` を実行したか
- [ ] コマンド結果で `Build and Deploy` が正常終了（Success）だったか
- [ ] コマンド結果で `https://garyohosu.github.io/` が 200/3xx 応答だったか
- [ ] コマンド結果で当該コミットの変更記事URL（`/posts/<slug>/`）が 200/3xx 応答だったか

---

## インシデント記録

### カテゴリー1: URLとファイル名の問題
#### 2026-01-26: URLスラッグ衝突
**症状**: 1/26の記事をクリックすると1/20の記事が表示される
**原因**: スラッグ名が同一だったため。
**解決**: リネーム。

#### 2026-01-28: HTTPリンクエラー
**症状**: GitHub Actionsでビルド失敗。
**原因**: `http://` リンクが含まれていた。
**解決**: `https://` に修正。

---

### カテゴリー6: 環境依存の問題 (Windows/PowerShell)
#### 2026-02-04: Gitコミットメッセージ文字化け
**症状**: 日本語コミットメッセージが文字化けする。
**原因**: PowerShellとGitのエンコーディング不整合。
**解決**: 英語メッセージを使用、またはUTF-8ファイル経由。
**再発防止**: 原則英語メッセージを使用する。

### カテゴリー7: Jekyllビルドエラー
#### 2026-02-04: 数値タグによるLiquid Exception
**症状**: GitHub Actionsで `undefined method 'gsub' for an instance of Integer` エラーが発生しビルド失敗。
**原因**: 記事のタグに数値の `403` を指定したため、Jekyllがこれを整数として扱い `slugify` フィルタ内でクラッシュした。
**解決**: 数値をダブルクォートで囲み文字列とした (`"403"`)。
**再発防止**: 数字のみのタグやカテゴリーは必ずクォートする。

#### 2026-02-24: HTMLProofer画像リンク切れ + YAML引用符エラー
**症状**: GitHub Actionsの `Test site` で `internal image ... does not exist` により失敗。`Build site` では YAML Exception も発生。
**原因**: 記事のフロントマター `image` が存在しない内部パス（`/auto-ai-blog/...`）を指していた。別記事の `title` で入れ子の `"` を未エスケープで使用していた。
**解決**: `assets/img/` に画像を追加し、`image` をローカル画像パスへ修正。`title` の入れ子引用符を `「」` に修正。
**再発防止**: `image.path` だけでなく `image` も実在ファイルを指すことをチェックし、YAML入れ子引用符を事前確認する。

### カテゴリー8: 運用フローの問題
#### 2026-02-24: push後確認が手動依存で漏れる問題
**症状**: push後の `Build and Deploy` 失敗をその場で検知できず、修正が後追いになった。
**原因**: ルールが人手確認前提で、自動確認コマンドが未整備だった。
**解決**: `scripts/ai-post-push-check.mjs` を追加し、push後チェックをAIの自動実行手順に変更。
**再発防止**: AIエージェントは push直後に `node scripts/ai-post-push-check.mjs` を必ず実行する。

### カテゴリー9: 画像生成API運用の問題
#### 2026-02-25: 画像生成サイズ指定ミスマッチ
**症状**: サムネイル生成時に `Invalid value: '1792x1024'` エラーが発生し、画像が生成されない。
**原因**: `gpt-image-1` の許容サイズと `dall-e-3` の推奨サイズを混同した。
**解決**: `pic.md` 手順どおり `dall-e-3` + `1792x1024` + `quality: hd` に修正して再生成。
**再発防止**: 画像生成前に `model` と `size` の対応をチェックリストで確認する。

---

## 更新履歴
- 2026-01-26: プロジェクト概要・コマンドを追加、共通ナレッジベース化
- 2026-02-04: Windows環境でのGitコミット文字化け問題を追加
- 2026-02-04: 数値タグによるビルドエラーの記録とチェックリスト強化
- 2026-02-24: HTMLProofer画像リンク切れとYAML引用符エラーの記録を追加
- 2026-02-24: push後確認をAI自動確認（`ai-post-push-check.mjs`）へ移行
- 2026-02-25: 画像生成APIサイズ指定ミスマッチの記録とチェック項目を追加
