# AGENTS.md - ブログ運用ナレッジベース

このファイルはAIエージェント（Claude Code / Codex CLI / Gemini CLI）がブログを運用する際の共通ナレッジベースです。

---

## プロジェクト概要

- **種別**: Jekyll静的ブログサイト（Chirpyテーマ）
- **ホスティング**: GitHub Pages
- **URL**: https://garyohosu.github.io/

## ファイル構成

```
├── CLAUDE.md       # Claude Code用（AGENTS.mdを参照）
├── AGENTS.md       # 共通ナレッジベース（このファイル）
├── CHANGELOG.md    # 変更履歴
├── _posts/         # ブログ記事
├── assets/img/     # 画像ファイル
└── _config.yml     # Jekyll設定（変更注意）
```

## よく使うコマンド

```bash
# 類似ファイル名の確認（記事作成前に必須）
ls _posts/ | grep -i "<キーワード>"

# ローカルビルド（推奨）
bundle exec jekyll build

# Git操作
git status
git diff
git add <file>
git commit -m "メッセージ"
git push
git pull --rebase
```

---

## 必読：運用ルール

### 1. 問題発生時の対応

**問題が発生し解決した場合は、必ず以下を実施すること**:

1. 本ファイル（AGENTS.md）の「インシデント記録」セクションに追記
2. 原因と解決方法を明記
3. 再発防止策を「再発防止チェックリスト」に追加

### 2. 変更管理

**何か変更を行った場合は、必ずCHANGELOG.mdに追記すること**:

```markdown
## YYYY-MM-DD
### 変更内容
- 変更した内容の概要
### 理由
- なぜ変更したか
```

---

## 再発防止チェックリスト

### 記事作成前

- [ ] `ls _posts/ | grep "<キーワード>"` で類似ファイル名を確認
- [ ] ファイル名のスラッグ部分が一意か確認（週番号・日付などの識別子を付ける）
- [ ] YAMLフロントマターの引用符が正しいか確認（入れ子の`"`は`「」`に変換）

### 記事作成時

- [ ] `image.path`に指定した画像ファイルが`assets/img/`に存在するか確認
- [ ] note記事紹介時は汎用画像でなく個別のOG画像を取得・保存
- [ ] 外部URLを使う場合はURLが有効か確認
- [ ] 外部URLが全て`https://`で始まっているか確認（`http://`はエラーになる）

### プッシュ前

- [ ] `git status`で意図しない変更がないか確認
- [ ] `git diff`で変更内容を確認（特に`_config.yml`の変更に注意）
- [ ] 可能であれば`bundle exec jekyll build`でローカルビルド確認

### プッシュ後

- [ ] GitHub Actionsのビルド結果を確認（`gh run list --limit 1`）
- [ ] **エラーがあれば次の記事をプッシュする前に必ず修正する**（連続エラー防止）
- [ ] サイトにアクセスして記事が正しく表示されるか確認
- [ ] リンクをクリックして正しいページに遷移するか確認

---

## インシデント記録

### カテゴリー1: URLとファイル名の問題

#### 2026-01-26: URLスラッグ衝突

**症状**: 1/26の記事をクリックすると1/20の記事が表示される

**原因**:
- `2026-01-20-ai-trends-2026.md`と`2026-01-26-ai-trends-2026.md`が同じスラッグ
- Jekyllは日付部分をURLに含めないため、`/posts/ai-trends-2026/`が衝突

**解決**: ファイル名を`2026-01-26-ai-trends-january-week4.md`にリネーム

**再発防止**:
- 同じテーマの連続記事は`week1`、`week2`などの識別子を付ける
- 作成前に`ls _posts/ | grep`で既存ファイルを確認

#### 2026-01-28: HTTPリンクエラー

**症状**: GitHub Actionsで`is not an HTTPS link`エラー、ビルド失敗

**原因**:
- Web検索結果から取得したURLが`http://`で始まっていた
- HTML-Prooferはセキュリティ上の理由でHTTPリンクをエラーにする

**解決**: `http://`を`https://`に変換

**再発防止**:
- 外部URLは必ず`https://`で始まっているか確認
- Web検索結果のURLはそのまま使わず、プロトコルを確認

---

### カテゴリー2: YAMLフロントマターの問題

#### 2026-01-15: 引用符の入れ子エラー

**症状**: タイトルが表示されない、日付が間違っている

**原因**:
```yaml
# NG: ダブルクォート内にダブルクォート
title: "エージェントが"言語で交渉"する"
```

**解決**:
```yaml
# OK: 鉤括弧を使用
title: "エージェントが「言語で交渉」する"
```

**再発防止**:
- タイトルにクォートを含める場合は`「」`を使用
- シングルクォートで囲む: `title: 'タイトルに"引用"を含む'`
- エスケープする: `title: "タイトルに\"引用\"を含む"`

---

### カテゴリー3: 画像関連の問題

#### 2025-11-15/16: 画像ファイル欠落（htmlprooferエラー）

**症状**: GitHub Actionsで`internal image does not exist`エラー

**原因**: フロントマターに`image.path`を指定したが、実際のファイルがない

**解決**: note記事のOG画像をダウンロードして`assets/img/`に保存

**再発防止**:
- 記事作成時に画像ファイルの存在を必ず確認
- `bundle exec jekyll build`でローカルビルド確認

#### 2025-11-13: サムネイル画像の使い回し

**症状**: 複数記事で同じサムネイルが表示される

**原因**: 汎用の`note.png`を複数記事で使い回し

**解決**: 記事ごとに個別の画像を取得・保存

**再発防止**:
- note記事紹介時は必ず個別のOG画像を保存
- ファイル命名規則: `YYYY-MM-DD-<サービス>-<テーマ>.png`

#### 2025-10-31: フロントマター欠落

**症状**: 一覧ページでサムネイルが表示されない

**原因**: フロントマターが空（`---\n---`）で`image.path`がない

**解決**: 必要なフロントマターフィールドを追加

**再発防止**:
- テンプレートを使用して記事を作成
- 必須フィールド: `layout`, `title`, `date`, `categories`, `tags`, `image.path`

---

### カテゴリー4: 設定ファイルの問題

#### 2025-10-09: Jekyll依存関係エラー

**症状**: `Could not find gem 'jekyll-sass-converter (~> 2.2)'`

**原因**: Gemfileでテーマが管理する依存関係を重複指定

**解決**: Gemfileから不要な依存関係を削除

**再発防止**:
- テーマが管理する依存関係は明示的に指定しない
- エラー時は`bundle install`の出力を確認

#### 2025-09-09: テーマ誤変更

**症状**: サイトのスタイルが崩れる

**原因**: `_config.yml`のtheme名を誤って変更（`chirpy`→`hacker`）

**解決**: 正しいテーマ名に戻す

**再発防止**:
- `git diff`で`_config.yml`の変更を必ず確認
- コミット前に変更内容を目視確認

#### 2025-09-09: CSS適用問題

**症状**: カスタムCSSが本番環境で反映されない

**原因**: Chirpyテーマのベースimportが欠如

**解決**:
```scss
---
---
@use 'main...'; // テーマベースを最初に読み込む
/* カスタムCSSはここ以降 */
```

**再発防止**:
- Chirpyテーマでは必ず`@use 'main'`を最初に記述
- カスタムCSSは`/* append your custom style below */`以降に記述

---

### カテゴリー5: CLI/ツールの問題

#### 2025-11-25: Gemini CLI起動エラー

**症状**: MCPサーバー接続エラー、モデル名エラー

**原因**:
- 存在しないMCPサーバー（codex）が設定に残っている
- 存在しないモデル名（gemini-3.0-pro）を指定

**解決**:
- `~/.gemini/settings.json`から不要なMCPサーバー設定を削除
- `gemini models list`で利用可能なモデル名を確認

**再発防止**:
- `gemini mcp list`でMCPサーバーの接続状態を確認
- `gemini models list`でモデル名を確認してから使用

#### 2025-11-26: Codex CLI起動エラー

**症状**: MCPサーバー起動失敗、非推奨警告

**原因**:
- 動作しないMCPサーバー（dalle, serena）が設定されている
- `tools.web_search`が非推奨

**解決**:
- `~/.codex/config.toml`で不要なMCPサーバーをコメントアウト
- `tools.web_search` → `features.web_search_request`に移行

**再発防止**:
- 使用しないMCPサーバーは設定から削除またはコメントアウト
- 非推奨警告が出たら対応方法を確認して移行

---

## ファイル命名規則

### 記事ファイル

```
YYYY-MM-DD-<トピック>-<識別子>.md
```

**識別子の例**:
- 週番号: `week1`, `week2`, `week3`, `week4`
- 月名: `january`, `february`
- 特定日: `jan26`, `0126`
- バージョン: `v1`, `v2`

**良い例**:
```
2026-01-20-ai-trends-week3.md
2026-01-26-ai-trends-week4.md
2026-01-26-jekyll-url-slug-collision.md
```

**悪い例**:
```
2026-01-20-ai-trends-2026.md
2026-01-26-ai-trends-2026.md  ← 衝突！
```

### 画像ファイル

```
YYYY-MM-DD-<サービス名>-<テーマ>.png
```

**例**:
```
2025-11-12-note-genspark-ai-browser.png
2025-11-11-note-okinawan-dialect.png
```

---

## 更新履歴

- 2026-01-26: 初版作成（URLスラッグ衝突の再発防止策）
- 2026-01-26: 過去の全インシデントを追加、運用ルールを整備
- 2026-01-26: プロジェクト概要・コマンドを追加、共通ナレッジベース化
- 2026-02-04: Windows環境でのGitコミット文字化け問題と対策を追加

---

### カテゴリー6: 環境依存の問題 (Windows/PowerShell)

#### 2026-02-04: Gitコミットメッセージ文字化け

**症状**: `git commit -m "日本語"` を実行すると、ログやGitHub上で「蟷ｴ」のように文字化けする

**原因**:
- Windows PowerShell (CP932/Shift-JIS) と Git (UTF-8) のエンコーディング不整合
- CLIツール経由で引数として日本語を渡す際の変換エラー

**解決**:
- コミットメッセージを**英語**に変更して再プッシュ (`git commit --amend`)
- 日本語を使用する場合は、UTF-8で保存したテキストファイルを `-F` オプションで渡す

**再発防止**:
- **Windows環境でのGit操作は、原則として英語のコミットメッセージを使用する**
- AIエージェントがコマンドを生成する際も、コミットメッセージは英語を指定する

